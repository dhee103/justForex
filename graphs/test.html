<!DOCTYPE html>
<html>
<head>
  <title> Graphs Testing </title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <!-- Highstocks -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/highcharts-more.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
</head>

<body>

  <div class="container">
    <div id="qunit"></div>
  </div>

  <script type="text/javascript">
      var $container = $('#container');





    var numberFormat = Highcharts.numberFormat,
        dateFormat = Highcharts.dateFormat,
        defaultOptions = Highcharts.getOptions();

    function sprintf (format, val) {
        var floatRegex = /f$/,
            decRegex = /\.([0-9])/,
            lang = defaultOptions.lang,
            decimals;


        if (floatRegex.test(format)) { // float
            decimals = format.match(decRegex);
            decimals = decimals ? decimals[1] : 6;
            val = numberFormat(
                val,
                decimals,
                lang.decimalPoint,
                format.indexOf(',') > -1 ? lang.thousandsSep : ''
            );
        } else {
            val = dateFormat(format, val);
        }
        return val;
    }

    function format(str, ctx) {
        var splitter = /({)([a-zA-Z0-9:%,\-\.]+)(})/g,
            //replacer = /({)([a-zA-Z]+)(\.)([a-zA-Z]+)(:)?([a-zA-Z0-9%\-,\.]+)?(})/g,
            arr = str.split(splitter),
            valueAndFormat,
            path,

            i = 0,
            len = arr.length,
            j,
            jLen,
            ret = [],
            val;

        for (; i < len; i++) {
            // Entering a variable
            if (arr[i] === '{' && arr[i + 2] === '}') {
                valueAndFormat = arr[i + 1].split(':');
                path = valueAndFormat.shift().split('.'); // get first and leave format
                jLen = path.length;
                val = ctx;

                // Assign deeper paths
                for (j = 0; j < jLen; j++) {
                    val = val[path[j]];
                }

                // Format the replacement
                if (valueAndFormat.length) {
                    val = sprintf(valueAndFormat.join(':'), val);
                }

                // Push the result and advance the cursor
                ret.push(val);
                i += 3;
            }

            ret.push(arr[i]);
        }
        return ret.join('');
    }


    // Test run
    var point = {
        key: 'January',
        value: Math.PI,
        long: 12345.6789,
        date: Date.UTC(2012, 0, 1),
        deep: {
            deeper: 123
        }
    };



    test("Number formats", function () {

        ok(format("{point.value}", { point: point }) == Math.PI);

        ok(format("{point.value:.2f}", { point: point }) == "3.14");

        // localized thousands separator and decimal point
        defaultOptions = Highcharts.setOptions({
            lang: {
                decimalPoint: ',',
                thousandsSep: ' '
            }
        });
        ok(format("{point.long:,.2f}", { point: point }) == "12 345,68");

        // default thousands separator and decimal point
        defaultOptions = Highcharts.setOptions({
            lang: {
                decimalPoint: '.',
                thousandsSep: ','
            }
        });
        ok(format("{point.long:,.2f}", { point: point }) == "12,345.68");

        // Date format with colon
        ok(format("{point.date:%H:%M:%S}", { point: point }) == "00:00:00");

        // Deep access
        ok(format("{point.deep.deeper}", { point: point }) == "123");

        // Shallow access
        ok(format("{value}", { value: 123 }) == "123");

        // Formatted shallow access
        ok(format("{value:.2f}", { value: 123 }) == "123.00");

        // Six decimals by default
        ok(format("{value:f}", { value: 12345 }) == "12345.000000");

    });
    test("Complicated string", function () {
        var s = format("Key: {point.key}, value: {point.value:.2f}, date: {point.date:%Y-%m-%d}.", { point: point });
        ok(s == "Key: January, value: 3.14, date: 2012-01-01.");

    });
</script>
</body>
